# Copyright (c) 2023 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: intel-qat-workload
  namespace: intel-qat
spec: {}
---
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: intel-qat-workload
  namespace: intel-qat
spec:
  triggers:
    - type: "ConfigChange"
    - type: "ImageChange"
  runPolicy: "Serial"
  source:
    type: Dockerfile
    dockerfile: |
        
        FROM registry.access.redhat.com/ubi8/ubi 
        ARG QATLIB_VERSION

        RUN dnf -y update && \
            dnf install -y gcc \
              make \
              automake \ 
              autoconf \
              libtool \
              http://mirror.centos.org/centos/8-stream/PowerTools/x86_64/os/Packages/nasm-2.15.03-3.el8.x86_64.rpm \
              openssl-devel \
              zlib-devel \
              git && \
              git clone -b $QATLIB_VERSION https://github.com/intel/qatlib
            
          RUN cd /qatlib && \
              ./autogen.sh && \
              ./configure \
              --prefix=/usr \
              --enable-systemd=no && \
              make -j && \
              make install samples-install

          WORKDIR  /usr/bin
          ENTRYPOINT  ["/usr/bin/cpa_sample_code"]
  strategy:
    type: Docker
    noCache: true
    dockerStrategy:
      buildArgs:
          - name: "QATLIB_VERSION"
            value: "23.08.0"

  output:
    to:
      kind: ImageStreamTag
      name: intel-qat-workload:latest